<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/_src/styles/fonts.css">
    <link rel="stylesheet" href="/_src/styles/header.css">
    <link rel="stylesheet" href="/_src/styles/main.css">
    <link rel="stylesheet" href="/_src/styles/topbar.css">
    <link rel="stylesheet" href="/_src/styles/sidebar.css">
    <link rel="stylesheet" href="/_src/styles/lesson.css">
    <link rel="stylesheet" href="/_src/styles/code.css">
    <link rel="stylesheet" href="/_src/styles/footer.css">
    <link rel="stylesheet" href="/_src/styles/responsive.css">
    <script src="https://kit.fontawesome.com/2c38f3d850.js" crossorigin="anonymous"></script>

    <title> | Modulo 3 - Backend </title>
  </head>

  <body>
    <div class="reader-bar-start">

      <div class="headerResponsive">
        <div class="leftContent">
          <span><img src="/_src/assets/logo-white.png" alt='logo Henry' height=22px class="d-inline-block align-text-top"></span><span></span>
        </div>
        <div class="menuDiv">
          <input type="checkbox">
          <i class="fas fa-bars"></i>
          <i class="fas fa-times"></i>
          <nav>
            <ul><li><a href="/">Intro</a></li>
<li><a href="/node/">Node</a></li></ul>
          </nav>
        </div>
      </div>

      <div class="headerContainer">
        <div class="headerContained">
          <img src="/_src/assets/logo-white.png" alt='logo Henry' height=27px class="d-inline-block align-text-top">
          <div>
            <span class="lessonTitle"></span> | <span>Prep Course</span>
          </div>
        </div>
      </div>

      <main>
        <div class="topnav" id='myTopnav' >
          
          <ul class="nav">
      
      <li class="link">
        <a href="/" class="nav-link" role="menuitem">Intro</a>
      </li>
<li class="link">
        <a href="/node/" class="nav-link" role="menuitem">Node</a>
      </li>
    </ul>
        </div>

        <div class='sidebar'>
          <div class="tocTitle">
            Contenido de la clase
            </div>
          <div class="tocBox">
            
            <nav class="toc" >
        <ul><li><a href="#promises-al-rescate">Promises al rescate </a></li><li><a href="#%C2%BFqu%C3%A9-es-una-promesa%3F">¿Qué es una Promesa? </a><ul><li><a href="#terminolog%C3%ADa-de-promises%3A">Terminología de promises: </a></li></ul></li><li><a href="#promises-en-javascript">Promises en JavaScript </a><ul><li><a href="#creando-una-promesa">Creando una promesa </a></li><li><a href="#haciendo-algo-cuando-una-promesa-se-%E2%80%98cumple%E2%80%99">Haciendo algo cuando una promesa se ‘cumple’ </a></li><li><a href="#encadenando-promesas">Encadenando Promesas </a></li><li><a href="#esperando-que-varias-promesas-se-cumplan-para-hacer-algo">Esperando que varias Promesas se cumplan para hacer algo </a></li></ul></li><li><a href="#bluebird">BlueBird </a></li></ul>
      </nav>
          </div>
        </div>

        <div class='lesson'>
          <div style="display:flex; justify-content: right; right: 0; width: 100%;">
            <div class="readingTime">
                    Tiempo de lectura 23 min
            </div>
          </div>
          <div>
            
            <p><img src="/_src/assets/logo.png" alt="HenryLogo"></p>
<table width="100%" style='table-layout:fixed;'>
  <tr>
	  <td>
	  	<a href="https://airtable.com/shrBpWkYV4K12PPNZ?prefill_clase=02-Promises">
			<img src="https://static.thenounproject.com/png/204643-200.png" width="100"/>
			<br>
			Hacé click acá para dejar tu feedback sobre esta clase.
	  	</a>
	  </td>
    	      <td>
      <a href="https://quiz.soyhenry.com/evaluation/new/60931e4456b4056ff032a73f">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/HSQuiz.svg/768px-HSQuiz.svg.png" width="100" height="100"/>
        <br>
        Hacé click acá completar el quizz teórico de esta lecture.
      </a>
  </td>
  </tr>
</table>
<h1 id="promises" tabindex="-1">Promises <a class="anchor-link" href="#promises"></a></h1>
<p>Javascript es muy potente a la hora de trabajar con tareas asincrónicas, de hecho, ya venimos programando funciones y código que hacen uso de <code>callbacks</code> para ejecutar código en el futuro cercano, cuando un evento sucede o cuando se termina la ejecución de un proceso (escribir en la bd, o escribir en el disco, hacer un request http, etc…).<br>
Esto es genial, pero a veces nos sucede que tenemos callbacks anidadas, es decir, que dentro de un callback tenemos otro callback y así sucesivamente ( inception de callbacks ), y tambien tenemos problemas donde tenemos que esperar que <em>dos o más</em> eventos terminen para continuar la ejecución de nuestro código. Si bien podemos resolverlo sin problemas con callbacks, vamos a ver que nuestro código empieza a hacerce díficil de leer, muy díficil de controlar si hay errores (no sabemos qué función es la que realmente produjo el error ), y si tenemos que buscar un bug dentro del código nos daremos cuenta que, sin querer, hemos terminado dentro del :japanese_goblin: <strong>Callback Hell</strong>:</p>
<p><img src="./img/callback_hell.gif" alt="callbackHell"></p>
<p>También conocido como <strong>Pyramid of Doom</strong> :scream::</p>
<p><img src="./img/pyr-1.png" alt="PyramidOfDoom"></p>
<p>Se pueden imaginar, por los nombres que eligieron para esto, que no es una situación deseada en nuestro código. También van a pensar, que es un mal necesario, ya que de esta forma puedo lograr que mi aplicación se comporte de acuerdo a los requerimientos asincrónicos que hay en el medio.</p>
<h2 id="promises-al-rescate" tabindex="-1">Promises al rescate <a class="anchor-link" href="#promises-al-rescate"></a></h2>
<p>Cuando programamos en lenguajes que son bloqueantes, como <code>C++</code> o <code>python</code>, perdemos el poder del asincronismo, pero ganamos legibilidad, ya que una línea de código se ejecuta exactamente cuando termina al anterior (si la anterior tarda 3 horas, vamos a esperar a que termine), esto hace que el código sea fácil de leer ya que siguiendo la línea de ejecución vamos a ver que cosas suceden antes o después, esto mismo no lo podemos hacer con callbacks (o por lo menos sin entrar al <em>Callback hell</em>.):</p>
<p><img src="./img/software-architecture-introduction-3.png" alt="SyncVsAsync"></p>
<p>¿No sería genial si pudieras escribir código como si fuera sincrónico, pero que la ejecución fuera asincrónica? Esta pregunta seguramente se hicieron los inventores de las <strong>Promises</strong> de javascript!<br>
Justamente las <strong>Promises</strong> en Js intentan solucionar el problema del <em>callback hell</em> y lograr que el código sea más legible, más fácil de debuggear y que tengamos mayor control sobre los errores. Veamos como funcionan las promises.</p>
<h2 id="%C2%BFqu%C3%A9-es-una-promesa%3F" tabindex="-1">¿Qué es una Promesa? <a class="anchor-link" href="#%C2%BFqu%C3%A9-es-una-promesa%3F"></a></h2>
<p>Una <em>promesa</em> representa el resultado eventual (en un futuro incierto) de una operación asincrónica, como por ejemplo: un registro de una db, una página que pedimos por http, un objeto JSON que es respuesta de un request a un API. Es decir, que representa un <em>placeholder</em> (un lugar reservado) donde vamos a guardar la respuesta del método asincrónico ( o un posible error en caso que no sea existosa ).<br>
Como nos podemos imaginar, una promesa puede ser exitosa o no, y una misma promesa no se puede ejecutar dos veces, una vez que termina se convierte en <strong>inmutable</strong> (no puede cambiar). Además si a una promesa le agregamos un callback (le podemos agregar en cualquier momento), este será ejecutará cuando esta termine. Esto es genial, porque ya no nos interesa en qué momento se producen las cosas, si no en reaccionar al resultado de esas cosas.</p>
<h3 id="terminolog%C3%ADa-de-promises%3A" tabindex="-1">Terminología de promises: <a class="anchor-link" href="#terminolog%C3%ADa-de-promises%3A"></a></h3>
<p>Una promesa puede estar:</p>
<ul>
<li><em>Pendiente</em> (pending): El estado inicial de un promise.</li>
<li><em>Completada</em> (fullfilled): Representa que se completó de manera exitosa.</li>
<li><em>Rechazada</em> (rejected): La operación terminó, pero de manera fallida.</li>
<li><em>Terminada</em> (settled): La operación terminó, de cualquiera de las dos maneras anteriores.</li>
</ul>
<h2 id="promises-en-javascript" tabindex="-1">Promises en JavaScript <a class="anchor-link" href="#promises-en-javascript"></a></h2>
<p>Antes de <strong>ES6</strong> (EcmaScript 6) javascript no soportaba nativamente las <em>Promises</em>, pero como el concepto ya estaba dando vuelta en la cabeza de algunos desarrolladores aparecieron varias librerías que lo implementaban, por ejemplo:</p>
<ul>
<li><a href="https://github.com/kriskowal/q">Q</a></li>
<li><a href="https://github.com/cujojs/when">When</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/windows/apps/br211867.aspx">WinJS</a></li>
<li><a href="https://github.com/tildeio/rsvp.js">RSPV.js</a></li>
<li><a href="http://bluebirdjs.com/docs/getting-started.html">Bluebird</a></li>
</ul>
<p>Si bien el concepto es el mismo, y de hecho se creó un standard para las promises: el <a href="https://github.com/promises-aplus/promises-spec">Promises/A+</a>, no todas las implementaciones son iguales ni respetan el standard. Ustedes se preguntarán porque no usamos directamente las promises que definieron los científicos de EcmaScript, pero resulta que hay un <em>serio</em> debate online por las perfomances de las mismas en términos de tiempo y memoria, la gente de Bluebird hizo algunos <a href="https://github.com/petkaantonov/bluebird/tree/master/benchmark">benchmarks</a>, y si los examinamos vemos que las promesas <em>nativas</em> de <strong>ES6</strong> están todavía muy abajo en la lista. Esto es debido a la implementación de cada librería sobre las promesas, y por lo visto la implementación nativa no es tan buena todavía. Así que por ahora todavía nos conviene usar alguna librería externa, como por ejemplo <em>Bluebird</em> que veremos más abajo.</p>
<blockquote>
<p>El autor de <em>Bluebird</em> explica un poco porqué tanta diferencia de perfomance en este <a href="http://programmers.stackexchange.com/questions/278778/why-are-native-es6-promises-slower-and-more-memory-intensive-than-bluebird">link</a>.</p>
</blockquote>
<h3 id="creando-una-promesa" tabindex="-1">Creando una promesa <a class="anchor-link" href="#creando-una-promesa"></a></h3>
<p>Una <em>Promise</em> es una clase en JavaScript, así que para instanciar una nueva vamos a el keyword <code>new</code>. Una <em>Promise</em> recibe un sólo argumento: una función con dos parámetros: <code>reject</code> y <code>resolve</code>. Dentro de esta función vamos a hacer lo que necesitemos y, si todo salió bien, llamamos <code>resolve</code> y si no, (algo salió mal), llamamos <code>reject</code>.</p>
<pre class="language-javascript"><code class="hljs language-javascript"><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Hacer cosas acá dentro, probablemente asincrónicas.</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* Todo funcionó como esperabamos*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"Jooya!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Algo se rompió"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p>En el método <code>reject</code> podemos pasar cualquier cosa, pero se recomienda devolver un objeto de tipo <code>Error</code> ya que estos tienen el <code>stack trace</code> y es más fácil de debugear.</p>
</blockquote>
<h3 id="haciendo-algo-cuando-una-promesa-se-%E2%80%98cumple%E2%80%99" tabindex="-1">Haciendo algo cuando una promesa se <em>‘cumple’</em> <a class="anchor-link" href="#haciendo-algo-cuando-una-promesa-se-%E2%80%98cumple%E2%80%99"></a></h3>
<p>En el statement anterior hemos <em>definido</em> una promesa y la hemos guardado en la variable <code>promise</code>. Ahora, para usar esa promesa, debemos de alguna forma poder decirle qué hacer cuando se resuelva o se rechaze la promesa. Para eso vamos a usar el método <code>then</code>:</p>
<pre class="language-javascript"><code class="hljs language-javascript">promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Ejecuto código sabiendo que todo salió bien</span><br>    <span class="token comment">// Siguiendo el ejemplo de arriba, data tendría adentro el string: 'Jooya!'</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// La promesa fue rechazada, aca ejecutamos código para ese caso</span><br>    <span class="token comment">// Siguiendo el ejemplo de arriba, error tendría adentro el string: 'Algo se rompió'</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>La función <code>then</code> de las <em>promises</em> recibe dos argumentos, un callback de <code>sucess</code> y un callback de <code>failure</code>, que van a ser llamadas según si el promise terminó en un <code>resolve</code> o un <code>reject</code> respectivamente. Los parámetros que le llegan a esta funcion (en el ejemplo <code>data</code> y <code>error</code>) son los mismos parámetros con los que llamamos a las funciones <code>resolve</code> y <code>reject</code>.<br>
Podemos escribir los mismo que arriba, pero en vez de pasar dos callbacks a <code>then</code>, vamos a usar otro método similar llamado <code>catch</code>. Básicamente, al separarlos de este modo, con el <code>then</code> vamos a llamar un callback cuando el Promise termina en éxito, y con <code>catch</code> vamos a llamar un callback cuando termina en error:</p>
<pre class="language-javascript"><code class="hljs language-javascript">promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Ejecuto código sabiendo que todo salió bien</span><br>  <span class="token comment">// Siguiendo el ejemplo de arriba, data tendría adentro el string: 'Jooya!'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// La promesa fue rechazada, aca ejecutamos código para ese caso</span><br>  <span class="token comment">// Siguiendo el ejemplo de arriba, error tendría adentro el string: 'Algo se rompió'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p>Este último pedazo de código con <code>then-catch</code> es equivalente (hace lo mismo) que el anterior donde <code>then</code> recibe dos callbacks. Es simplemente una forma más simple de escribir código.</p>
</blockquote>
<h3 id="encadenando-promesas" tabindex="-1">Encadenando Promesas <a class="anchor-link" href="#encadenando-promesas"></a></h3>
<p>Algo muy potente de las <em>Promises</em> es que vamos a poder encadenarlas (<em>chaining</em>), ya que podemos hacer que un <em>Promise</em> <strong>retorne</strong> otro <em>Promise</em>, y de esa forma ir encadenando métodos. Por ejemplo:</p>
<pre class="language-javascript"><code class="hljs language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">primerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el primer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>num<span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//pasamos unos datos para ver como los manejamos</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// para simular algo asincronico hacemos un setTimeOut de 2 s</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br> <br><span class="token keyword">var</span> <span class="token function-variable function">segundoMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datos</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el segundo método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>nuevosDatos<span class="token operator">:</span> datos<span class="token punctuation">.</span>num <span class="token operator">+</span> <span class="token string">' concatenamos texto y lo pasamos'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br><span class="token keyword">var</span> <span class="token function-variable function">tercerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datos</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el tercer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>datos<span class="token punctuation">.</span>nuevosDatos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//imprimos los datos concatenados</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'hola'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br><span class="token function">primerMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>   <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>segundoMetodo<span class="token punctuation">)</span><br>   <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>tercerMetodo<span class="token punctuation">)</span><br>   <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datos</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>   		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>datos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//debería ser el 'hola' que pasamos en tercerMetodo</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>En el ejemplo hemos creado tres métodos donde simulamos algo asincrónico, o sea que no sabemos cuando se va a terminar de ejecutar y como vemos, todos crean una <em>Promise</em> nueva dentro de ellos y la <strong>retornan</strong>. Para llamarlos, invocamos al primer métodos y le decimos con <code>then</code> que si termina éxitosamente ejecute la función <code>segundoMetodo</code>, esta también devuelve una <em>Promise</em>, por lo tanto también podemos llamar a <code>then</code> sobre ella, con esto invocamos tercerMetodo (que tambien retorna una <em>Promise</em>) y a este última le pasamos una función anónima pidiendo que imprima por consola los <em>datos</em> que recibió como argumento en <code>resolve</code>. Si lo ejecutan en su browser verán cómo es el flujo de datos y en qué orden se imprimen los <code>console.log</code>s.</p>
<blockquote>
<p>Intenten hacer el mismo ejemplo, pero sin usar Promises. Haciendólo van a notar la diferencia y vean cuan inentendible puede ser el  :japanese_goblin: <em>Callback Hell</em></p>
</blockquote>
<h3 id="esperando-que-varias-promesas-se-cumplan-para-hacer-algo" tabindex="-1">Esperando que varias Promesas se cumplan para hacer algo <a class="anchor-link" href="#esperando-que-varias-promesas-se-cumplan-para-hacer-algo"></a></h3>
<p>A veces no sólo necesitamos esperar por un evento para hacer algo, si no que queremos que varios eventos hayan sucedido para actuar. Por ejemplo, quiero guardar un arreglo de <code>alumnos</code> en una base de datos, y cuando estén todos correctamente guardados mostrar la respuesta al usuario. Para eso, la <code>API</code> de <em>Promises</em> no da el método <code>all</code>, el cual toma un arreglo de <em>Promises</em> y crea un <em>Promise</em> que se completa cuando todas las <em>Promises</em> que les pasamos estén completas. Al devolver una <em>Promise</em> vamos a poder invocar el método <code>then</code> sobre ella, y en el callback que les pasemos vamos a recibir como argumento un arreglo de los resultados de las <em>Promises</em> que les pasamos, en el mismo orden que se las pasamos:</p>
<pre class="language-javascript"><code class="hljs language-javascript">Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>arregloDePromesas<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arregloDeResultados</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">//...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Vamos a usar el ejemplo anterior, pero ahora queremos que los métodos se ejecuten sólo cuando se completaron los tres, para eso vamos a tener que cambiar cada método para que no utilize ningún dato del método anterior (ahora estamos llamando los tres al mismo tiempo) y la última parte y reemplazarla por <code>all</code>, en el callback de esta vamos a hacer un <code>console.log</code> del arreglo que nos devolvió:</p>
<pre class="language-javascript"><code class="hljs language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">primerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el primer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>num<span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//pasamos unos datos para ver como los manejamos</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// para simular algo asincronico hacemos un setTimeOut de 2 s</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br> <br><span class="token keyword">var</span> <span class="token function-variable function">segundoMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el segundo método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>texto<span class="token operator">:</span><span class="token string">' segundo metodo'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br><span class="token keyword">var</span> <span class="token function-variable function">tercerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datos</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el tercer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>hola<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">primerMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">segundoMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tercerMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resultado</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultado<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//un arreglo con los valores pasamos a resolve en cada metodo</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Genial, como vemos las promesas se completaron según cuanto tardaba cada una, en el ejemplo pusimos a propósito que el segundo método tarde menos que los demás. Lo importante a notar es que en el arreglo que recibimos al final los resultados vienen ordenados <strong>en el mismo orden en el que pasamos las <em>promises</em> a <code>all</code> y <em>no</em> en el orden en que se resuelven</strong>.</p>
<p>Seguramente se preguntarán qué pasa cuando una <em>Promise</em> es rechazada ( o sea que su ejecución termina en un <code>reject</code>). <code>Promise.all</code> fue diseñada con un comportamiento llamado <a href="https://en.wikipedia.org/wiki/Fail-fast"><em>fail-fast</em></a>, esto quiere decir que ni bien existe un reject, <code>all</code> ya lo reporta y devuelve el error. Es decir que el método <code>catch</code> va a seguir cómo antes, recibiendo sólo un párametro (el error), y este corresponderá a la <em>Promise</em> que falló primero.</p>
<p>Modifiquemos el código para que el método del medio termine en error. Vamos a rechazar dos promesas, una que termine primero y otra al final, vamos a ver que siempre se mostrará el error de la que <strong>falla primero</strong>:</p>
<pre class="language-javascript"><code class="hljs language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">primerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el primer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Esto es una prueba controlada'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// </span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br><span class="token keyword">var</span> <span class="token function-variable function">segundoMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el segundo método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>texto<span class="token operator">:</span><span class="token string">' segundo metodo'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br> <br><span class="token keyword">var</span> <span class="token function-variable function">tercerMetodo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datos</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>   <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Terminó el tercer método'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Tercer método falla'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>   <span class="token keyword">return</span> promise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">primerMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">segundoMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tercerMetodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resultado</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultado<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//un arreglo con los valores pasamos a resolve en cada metodo</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//mostramos el error por consola. Veremos que es el que falló primero, o sea el del primer metodo</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p>Noten que la Promise retorna y ejecuta el <code>catch</code> inclusive antes que termine el tercer método, esto se debe a que el primer método falla antes que se ejecute el tercero.</p>
</blockquote>
<h2 id="bluebird" tabindex="-1">BlueBird <a class="anchor-link" href="#bluebird"></a></h2>
<p>BlueBird es una librería enfocada en <em>Promises</em>, esta cumple con el standard de <a href="https://github.com/promises-aplus/promises-spec">Promises/A+</a>. Como dijimos antes, esta librería es más performante que las <em>Promises</em> nativas de <strong>EC6</strong> y sus diseñadores se aprovecharon de ello ya que las dos librerías son perfectamente intercambiables, es decir, que la sintaxis de <em>Promises</em> en nativo es idéntica a la de <em>Bluebird</em> (excepto en un <a href="http://bluebirdjs.com/docs/coming-from-other-libraries.html#coming-from-native-promises">estos</a> casos puntuales). Por lo tanto, para usarla vamos primero a instalarla: <code>npm install bluebird</code> y luego, vamos a reemplazar el objeto <code>Promise</code> que contiene la clase de las <em>Promises</em> con el módulo de <em>Bluebird</em>:</p>
<pre class="language-javascript"><code class="hljs language-javascript"><span class="token keyword">var</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"bluebird"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Listo! ahora podemos usar las Promesas de Bluebierd mejorando la performance de nuestra aplicación!</p>
<blockquote>
<p>:pineapple: Para ver todo lo que se puede hacer con <em>Promises</em> podemos ir a leer la <a href="http://bluebirdjs.com/docs/api-reference.html">documentación</a> de Bluebird.</p>
</blockquote>

          </div>
        </div>

      </main>

      <div class="feedback">
        <a href='https://airtable.com/shrBpWkYV4K12PPNZ?prefill_clase=' target="_blank">
          Dejanos tu feedback!👍
        </a>
      </div>

      <div class="footerContainer">
        <div class="footerContained">
          <p>Hecho con 💛 por alumnos de Henry</p>
        </div>
      </div>

      <div class="readerBarDiv">
        
  <!-- up button -->
  <div>
    <button
      id="upBtn"
      style="position:fixed; width:32px; height:32px; border-radius:50%; border:none; background-color:black; right:20px; bottom:55px; color:white; z-index:999; focus:outline-none; cursor:pointer; transition-duration:500ms; opacity:0; pointer-events:none;"
    ><i class="arrow up"></i></button>
  </div>
  
  <style>
  .arrow {
    border: solid white;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 3px;
  }

  .up {
    transform: rotate(-135deg);
    -webkit-transform: rotate(-135deg);
  }
  </style>

  <script>
  window.addEventListener('scroll', () => {
    if (window.scrollY > 250) {
      upBtn.style.opacity = 1;
      upBtn.style.pointerEvents = 'auto';     
    }
    else {
      upBtn.style.opacity = 0;
      upBtn.style.pointerEvents = 'none';
    }
  })

  upBtn.addEventListener('click', () => {
    let start = document.querySelector('.reader-bar-start')
    start.scrollIntoView({behavior: "smooth"})
  })
  </script>

  <!-- reader bar -->
  <div id="readerBarContainer" style="height:3px;width:100%;background-color:black;position:fixed;top:66px;left:0;z-index:1099;transition:0.2s;">
    <div id="readerBar" style="height:3px;width:0;background-color:yellow;position:fixed;top:66px;left:0;z-index:1099;transition:0.2s;"></div>
  </div>

  <script>
    let winH = window.innerHeight;
    const content = document.querySelector('.reader-bar-start');

    let contentH = content.offsetHeight;
    let contentS = contentH - winH;
    let readerBar = document.getElementById('readerBar');
    window.addEventListener('load', () => {
      document.addEventListener ('scroll', updateBar);
    })
    window.addEventListener('resize', redefine)

    function redefine() {
      winH = window.innerHeight;
      contentH = content.offsetHeight;
      contentS = contentH - winH;
      updateBar();
    }

    function updateBar() {
      const pagePos = window.scrollY; 
      const updatedBar = pagePos * 100 / contentS;
      readerBar.style.width = updatedBar + "%";
    }
  </script>
  
      </div>

    </body>
  </html>